<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Kelayakan Investasi Lanjutan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1a202c;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        #summaryText {
            white-space: pre-wrap;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="container flex flex-col lg:flex-row gap-8 bg-white rounded-xl shadow-lg p-8 mb-4">

        <!-- Input Section -->
        <div id="inputSection" class="lg:w-1/2 space-y-6 no-print">
            <header class="text-center space-y-2">
                <h1 class="text-3xl font-bold text-gray-800">Kalkulator Kelayakan Investasi</h1>
                <p class="text-gray-500">Menjer Ridge Cabins</p>
            </header>
            
            <!-- Scenario Selection -->
            <div class="p-4 bg-purple-50 rounded-lg text-center space-y-2">
                <h2 class="text-xl font-semibold text-purple-700">Pilih Model Investasi</h2>
                <div class="flex flex-wrap justify-center gap-4">
                    <label class="inline-flex items-center">
                        <input type="radio" id="buyOption" name="scenario" value="buy" class="form-radio h-4 w-4 text-purple-600" checked>
                        <span class="ml-2 text-gray-700 text-sm">Akuisisi Lahan (Tunai)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" id="loanOption" name="scenario" value="loan" class="form-radio h-4 w-4 text-purple-600">
                        <span class="ml-2 text-gray-700 text-sm">Akuisisi Lahan (Utang)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" id="leaseOption" name="scenario" value="lease" class="form-radio h-4 w-4 text-purple-600">
                        <span class="ml-2 text-gray-700 text-sm">Sewa Lahan</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" id="sharingOption" name="scenario" value="sharing" class="form-radio h-4 w-4 text-purple-600">
                        <span class="ml-2 text-gray-700 text-sm">Joint Venture</span>
                    </label>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-700 text-center">Asumsi Parameter</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Biaya Modal & Pembiayaan -->
                    <div class="space-y-2 p-4 bg-blue-50 rounded-lg">
                        <h3 class="text-md font-semibold text-blue-700">Modal & Biaya</h3>
                        <div id="landPriceInputContainer">
                            <label for="landPrice" class="block text-xs font-medium text-gray-600">Biaya Lahan (per mÂ²)</label>
                            <input type="text" id="landPrice" value="Rp 1.500.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                        <div id="landLeaseInputContainer" class="hidden">
                            <label for="landLeaseCost" class="block text-xs font-medium text-gray-600">Biaya Sewa Lahan (tahunan)</label>
                            <input type="text" id="landLeaseCost" value="Rp 500.000.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                        <div>
                            <label for="buildingCost" class="block text-xs font-medium text-gray-600">Biaya Konstruksi & Fasilitas</label>
                            <input type="text" id="buildingCost" value="Rp 3.850.000.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                         <div id="loanAssumptions" class="space-y-2 hidden">
                            <div>
                                <label for="equity" class="block text-xs font-medium text-gray-600">Rasio Ekuitas (%)</label>
                                <input type="number" id="equity" value="30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                            <div>
                                <label for="loanRate" class="block text-xs font-medium text-gray-600">Bunga Pinjaman Tahunan (%)</label>
                                <input type="number" id="loanRate" value="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                            <div>
                                <label for="loanTerm" class="block text-xs font-medium text-gray-600">Jangka Waktu Pinjaman (Tahun)</label>
                                <input type="number" id="loanTerm" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                        </div>
                        <div id="sharingAssumptions" class="space-y-2 hidden">
                            <div>
                                <label for="investorShare" class="block text-xs font-medium text-gray-600">Porsi Bagi Hasil Investor (%)</label>
                                <input type="number" id="investorShare" value="70" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                             <div>
                                <label for="landOwnerShare" class="block text-xs font-medium text-gray-600">Porsi Bagi Hasil Pemilik Lahan (%)</label>
                                <input type="number" id="landOwnerShare" value="30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                        </div>
                    </div>

                    <!-- Pendapatan & Biaya Operasional -->
                    <div class="space-y-2 p-4 bg-green-50 rounded-lg">
                        <h3 class="text-md font-semibold text-green-700">Pendapatan & OPEX</h3>
                        <div>
                            <label for="adrTipe1" class="block text-xs font-medium text-gray-600">ADR Tipe 1 (9 unit)</label>
                            <input type="text" id="adrTipe1" value="Rp 900.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                        <div>
                            <label for="adrTipe2" class="block text-xs font-medium text-gray-600">ADR Tipe 2 (5 unit)</label>
                            <input type="text" id="adrTipe2" value="Rp 750.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                        <div>
                            <label for="occupancy" class="block text-xs font-medium text-gray-600">Okupansi Tahunan (%)</label>
                            <input type="number" id="occupancy" value="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                        <div>
                            <label for="fnbRevenue" class="block text-xs font-medium text-gray-600">Pendapatan F&B (% dari Akomodasi)</label>
                            <input type="number" id="fnbRevenue" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                        <div>
                            <label for="opexRate" class="block text-xs font-medium text-gray-600">Rasio OPEX Variabel (%)</label>
                            <input type="number" id="opexRate" value="15" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                         <div>
                            <label for="fixedOpex" class="block text-xs font-medium text-gray-600">OPEX Tetap (tahunan)</label>
                            <input type="text" id="fixedOpex" value="Rp 500.000.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                        <div>
                            <label for="maintenanceRate" class="block text-xs font-medium text-gray-600">Biaya Pemeliharaan Tahunan (%)</label>
                            <input type="number" id="maintenanceRate" value="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                        </div>
                    </div>

                    <!-- Pertumbuhan & Lain-lain -->
                    <div class="col-span-1 md:col-span-2 space-y-2 p-4 bg-yellow-50 rounded-lg">
                        <h3 class="text-md font-semibold text-yellow-700">Pertumbuhan & Keuangan</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                <label for="revenueGrowth" class="block text-xs font-medium text-gray-600">Pertumbuhan Pendapatan Tahunan (%)</label>
                                <input type="number" id="revenueGrowth" value="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                            <div>
                                <label for="opexGrowth" class="block text-xs font-medium text-gray-600">Pertumbuhan OPEX Tahunan (%)</label>
                                <input type="number" id="opexGrowth" value="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                            <div>
                                <label for="taxRate" class="block text-xs font-medium text-gray-600">Tingkat Pajak Korporasi (%)</label>
                                <input type="number" id="taxRate" value="22" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                            <div>
                                <label for="discountRate" class="block text-xs font-medium text-gray-600">Tingkat Diskonto (%)</label>
                                <input type="number" id="discountRate" value="11" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <button id="calculateBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-colors duration-200 text-sm">
                    <span id="buttonText">Lakukan Proyeksi</span>
                    <span id="buttonSpinner" class="hidden spinner ml-2">
                        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="lg:w-1/2 space-y-6 flex flex-col print-section" id="resultsSection">
            <h2 class="text-xl font-bold text-gray-700 text-center">Indikator Kinerja Utama</h2>
            
            <!-- Minimalist Infographic Section (ROI Gauge) -->
            <div class="flex-grow flex flex-col items-center justify-center p-4 bg-gray-50 rounded-xl shadow text-center">
                 <svg id="roiGauge" class="w-36 h-36 lg:w-48 lg:h-48" viewBox="0 0 120 120">
                    <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60"></circle>
                    <circle id="roiArc" class="text-green-500 transition-all duration-700 ease-in-out" stroke-width="10" stroke="currentColor" fill="transparent" r="50" cx="60" cy="60" style="transform: rotate(-90deg); transform-origin: 50% 50%;"></circle>
                    <text id="roiText" x="60" y="60" text-anchor="middle" dominant-baseline="middle" class="text-2xl font-bold text-gray-800">0%</text>
                    <text x="60" y="80" text-anchor="middle" dominant-baseline="middle" class="text-sm font-medium text-gray-500">ROI</text>
                </svg>
                <p class="mt-4 text-sm text-gray-600">
                    ROI (Return on Investment) lebih dari 100% menandakan pengembalian modal pada tahun pertama.
                </p>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-4 text-center shadow">
                    <p class="text-xs text-gray-500">Total Biaya Modal (CapEx)</p>
                    <p id="totalCapex" class="text-lg font-bold text-gray-800">Rp 0</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 text-center shadow">
                    <p class="text-xs text-gray-500">Total Pendapatan Proyek (Tahun 1)</p>
                    <p id="totalRevenue" class="text-lg font-bold text-gray-800">Rp 0</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 text-center shadow">
                    <p class="text-xs text-gray-500">Laba Bersih Setelah Pajak (Tahun 1)</p>
                    <p id="netProfit" class="text-lg font-bold text-gray-800">Rp 0</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 text-center shadow">
                    <p class="text-xs text-gray-500">NPV (Net Present Value) (10 Tahun)</p>
                    <p id="npv" class="text-lg font-bold text-gray-800">Rp 0</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 text-center shadow">
                    <p class="text-xs text-gray-500">ROI (Return on Investment) (Tahun 1)</p>
                    <p id="roi" class="text-lg font-bold text-gray-800">0%</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 text-center shadow">
                    <p class="text-xs text-gray-500">Periode Pengembalian (Payback Period)</p>
                    <p id="payback" class="text-lg font-bold text-gray-800">0 tahun</p>
                </div>
                <div id="landOwnerProfitElContainer" class="bg-gray-50 rounded-xl p-4 text-center shadow hidden">
                    <p class="text-xs text-gray-500">Laba Bersih untuk Pemilik Lahan (Tahun 1)</p>
                    <p id="landOwnerProfit" class="text-lg font-bold text-gray-800">Rp 0</p>
                </div>
            </div>

            <!-- Gemini API Section -->
            <div id="geminiApiSection" class="p-4 bg-gray-100 rounded-lg space-y-4 text-center no-print">
                 <button id="generateSummaryBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition-colors duration-200 text-sm" disabled>
                     Buat Ringkasan Eksekutif
                 </button>
                 <div id="summaryContainer" class="hidden text-left p-4 bg-white rounded-lg shadow-inner mt-4">
                     <p id="summaryText" class="text-gray-700 leading-relaxed"></p>
                 </div>
            </div>

            <!-- Export Button -->
            <button id="exportBtn" class="no-print w-full bg-slate-500 text-white py-2 rounded-lg font-semibold shadow-md hover:bg-slate-700 transition-colors duration-200 text-sm mt-4" disabled>
                Ekspor Hasil Proyeksi
            </button>
        </div>
    </div>

    <!-- Hidden element for PDF generation -->
    <div id="reportContent" class="hidden p-8 font-sans text-sm w-[8.5in] h-[11in] mx-auto bg-white border border-gray-300"></div>

    <!-- Footer Section -->
    <footer class="w-full mt-4 flex flex-col items-center text-xs text-gray-600 space-y-4 no-print">
        <div class="max-w-4xl space-y-4 p-4 bg-red-50 rounded-lg text-sm text-center text-red-700 shadow-md">
            <p class="font-semibold">Disclaimer:</p>
            <p>Hasil perhitungan ini adalah estimasi awal berdasarkan asumsi yang Anda masukkan. Proyeksi keuangan aktual dapat bervariasi secara signifikan. Kalkulator ini berfungsi sebagai alat analisis pendahuluan dan bukan pengganti studi kelayakan bisnis yang komprehensif.</p>
        </div>
        <div class="max-w-4xl space-y-2 p-4 bg-gray-200 rounded-lg text-sm text-center text-gray-800 shadow-md">
            <h2 class="text-sm font-semibold text-gray-800 text-center">Landasan Ilmiah dan Sumber Data</h2>
            <p class="text-left mb-2">Perhitungan ini didasarkan pada prinsip-prinsip keilmuan, model bisnis, dan regulasi yang lazim dalam analisis kelayakan investasi. Berikut adalah rincian landasan teoritis dan sumber data yang digunakan:</p>
            <ul class="list-disc list-inside space-y-2 text-left">
                <li>
                    <strong>Analisis Keuangan dan Investasi:</strong> Metrik seperti EBIT, NPAT, NPV, dan ROI adalah metrik standar dalam akuntansi manajerial dan capital budgeting. Model ini mengintegrasikan proyeksi pendapatan, biaya operasional, dan biaya modal untuk menilai profitabilitas dan efisiensi investasi.
                </li>
                <li>
                    <strong>Sumber Data Proyeksi:</strong> Asumsi spesifik (misalnya, harga lahan, biaya konstruksi, harga kamar (ADR), dan tingkat okupansi) direplikasi dari dokumen terverifikasi, yaitu Audit Kelayakan Investasi â Menjer Ridge Cabins (final). Tingkat pertumbuhan pendapatan dan biaya operasional dipilih secara konservatif sebagai praktik terbaik dalam pemodelan keuangan.
                </li>
                <li>
                    <strong>Landasan Hukum Terkait Pajak:</strong> Asumsi tingkat pajak korporasi sebesar 22% mengacu pada Undang-Undang Nomor 7 Tahun 2021 tentang Harmonisasi Peraturan Perpajakan (UU HPP) yang berlaku di Indonesia. Ini merupakan regulasi vital yang memengaruhi profitabilitas bersih suatu entitas bisnis.
                </li>
                 <li>
                    <strong>Metode Penilaian Proyek:</strong> Perhitungan NPV menggunakan tingkat diskonto (11%) yang merepresentasikan biaya modal atau imbal hasil minimum yang diharapkan investor. Periode proyeksi 10 tahun dipilih untuk mencakup siklus hidup proyek dan memberikan gambaran jangka panjang yang komprehensif.
                </li>
            </ul>
        </div>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const luasLahan = 3072.9;
            const jumlahTipe1 = 9;
            const jumlahTipe2 = 5;
            const annualDays = 365;
            const projectionPeriod = 10;
            const apiKey = "";
            const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";

            const buyOption = document.getElementById('buyOption');
            const loanOption = document.getElementById('loanOption');
            const leaseOption = document.getElementById('leaseOption');
            const sharingOption = document.getElementById('sharingOption');
            const landPriceInputContainer = document.getElementById('landPriceInputContainer');
            const landLeaseInputContainer = document.getElementById('landLeaseInputContainer');
            const loanAssumptions = document.getElementById('loanAssumptions');
            const sharingAssumptions = document.getElementById('sharingAssumptions');
            const landOwnerProfitElContainer = document.getElementById('landOwnerProfitElContainer');
            
            const landPriceInput = document.getElementById('landPrice');
            const landLeaseCostInput = document.getElementById('landLeaseCost');
            const buildingCostInput = document.getElementById('buildingCost');
            const equityInput = document.getElementById('equity');
            const loanRateInput = document.getElementById('loanRate');
            const loanTermInput = document.getElementById('loanTerm');
            const investorShareInput = document.getElementById('investorShare');
            const landOwnerShareInput = document.getElementById('landOwnerShare');
            const adrTipe1Input = document.getElementById('adrTipe1');
            const adrTipe2Input = document.getElementById('adrTipe2');
            const occupancyInput = document.getElementById('occupancy');
            const fnbRevenueInput = document.getElementById('fnbRevenue');
            const opexRateInput = document.getElementById('opexRate');
            const fixedOpexInput = document.getElementById('fixedOpex');
            const maintenanceRateInput = document.getElementById('maintenanceRate');
            const revenueGrowthInput = document.getElementById('revenueGrowth');
            const opexGrowthInput = document.getElementById('opexGrowth');
            const taxRateInput = document.getElementById('taxRate');
            const discountRateInput = document.getElementById('discountRate');
            const calculateBtn = document.getElementById('calculateBtn');
            const exportBtn = document.getElementById('exportBtn');
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');
            const generateSummaryBtn = document.getElementById('generateSummaryBtn');
            const summaryContainer = document.getElementById('summaryContainer');
            const summaryText = document.getElementById('summaryText');
            
            const reportContentDiv = document.getElementById('reportContent');

            const totalCapexEl = document.getElementById('totalCapex');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const netProfitEl = document.getElementById('netProfit');
            const roiEl = document.getElementById('roi');
            const paybackEl = document.getElementById('payback');
            const npvEl = document.getElementById('npv');
            const landOwnerProfitEl = document.getElementById('landOwnerProfit');
            
            const roiArc = document.getElementById('roiArc');
            const roiText = document.getElementById('roiText');

            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            const numberFormatter = new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            let latestCalculatedMetrics = {};
            let latestSummaryText = '';

            const formatRupiah = (value) => {
                const number = parseFloat(value);
                if (isNaN(number)) return '';
                return `Rp ${number.toLocaleString('id-ID')}`;
            };

            const unformatRupiah = (text) => {
                const cleanedText = text.replace(/[^,\d]/g, '').replace(/,/g, '.');
                return parseFloat(cleanedText);
            };

            landPriceInput.value = formatRupiah(unformatRupiah(landPriceInput.value));
            buildingCostInput.value = formatRupiah(unformatRupiah(buildingCostInput.value));
            adrTipe1Input.value = formatRupiah(unformatRupiah(adrTipe1Input.value));
            adrTipe2Input.value = formatRupiah(unformatRupiah(adrTipe2Input.value));
            landLeaseCostInput.value = formatRupiah(unformatRupiah(landLeaseCostInput.value));
            fixedOpexInput.value = formatRupiah(unformatRupiah(fixedOpexInput.value));

            const formatInputs = (inputs, isRupiah) => {
                inputs.forEach(input => {
                    input.addEventListener('focus', (e) => {
                        const value = e.target.value;
                        if (isRupiah) {
                            const unformattedValue = unformatRupiah(value);
                            e.target.value = isNaN(unformattedValue) ? '' : unformattedValue;
                        } else {
                            e.target.value = value.replace(/%/g, '').trim();
                        }
                    });
                    input.addEventListener('blur', (e) => {
                        const value = e.target.value;
                        if (isRupiah) {
                            e.target.value = formatRupiah(value);
                        } else {
                            // Do nothing for number inputs on blur
                        }
                    });
                });
            };
            
            formatInputs([landPriceInput, buildingCostInput, adrTipe1Input, adrTipe2Input, landLeaseCostInput, fixedOpexInput], true);
            formatInputs([equityInput, loanRateInput, loanTermInput, investorShareInput, landOwnerShareInput, occupancyInput, fnbRevenueInput, opexRateInput, maintenanceRateInput, revenueGrowthInput, opexGrowthInput, taxRateInput, discountRateInput], false);


            const updateInputVisibility = () => {
                const isSharingScenario = sharingOption.checked;
                const isLoanScenario = loanOption.checked;
                const isBuyScenario = buyOption.checked;
                const isLeaseScenario = leaseOption.checked;

                if (isBuyScenario || isLoanScenario) {
                    landPriceInputContainer.classList.remove('hidden');
                } else {
                    landPriceInputContainer.classList.add('hidden');
                }

                if (isLeaseScenario) {
                    landLeaseInputContainer.classList.remove('hidden');
                } else {
                    landLeaseInputContainer.classList.add('hidden');
                }

                if (isLoanScenario) {
                    loanAssumptions.classList.remove('hidden');
                } else {
                    loanAssumptions.classList.add('hidden');
                }

                if (isSharingScenario) {
                    sharingAssumptions.classList.remove('hidden');
                    landOwnerProfitElContainer.classList.remove('hidden');
                } else {
                    sharingAssumptions.classList.add('hidden');
                    landOwnerProfitElContainer.classList.add('hidden');
                }
            };

            const calculateMetrics = () => {
                const isBuyScenario = buyOption.checked;
                const isLoanScenario = loanOption.checked;
                const isSharingScenario = sharingOption.checked;
                const currentScenario = document.querySelector('input[name="scenario"]:checked').value;

                const buildingCost = unformatRupiah(buildingCostInput.value) || 0;
                const adrTipe1 = unformatRupiah(adrTipe1Input.value) || 0;
                const adrTipe2 = unformatRupiah(adrTipe2Input.value) || 0;
                const occupancy = parseFloat(occupancyInput.value) / 100 || 0;
                const fnbRevenuePercent = parseFloat(fnbRevenueInput.value) / 100 || 0;
                const opexRate = parseFloat(opexRateInput.value) / 100 || 0;
                const fixedOpex = unformatRupiah(fixedOpexInput.value) || 0;
                const maintenanceRate = parseFloat(maintenanceRateInput.value) / 100 || 0;
                const revenueGrowth = parseFloat(revenueGrowthInput.value) / 100 || 0;
                const opexGrowth = parseFloat(opexGrowthInput.value) / 100 || 0;
                const taxRate = parseFloat(taxRateInput.value) / 100 || 0;
                const discountRate = parseFloat(discountRateInput.value) / 100 || 0;

                let totalCapex;
                let landLeaseCost = 0;
                let annualLoanPayment = 0;
                let investorSharePercent = 1; 
                let landOwnerSharePercent = 0;

                const landPrice = unformatRupiah(landPriceInput.value) || 0;
                const projectCost = (luasLahan * landPrice) + buildingCost;

                if (isBuyScenario) {
                    totalCapex = projectCost;
                } else if (isLoanScenario) {
                    const equityPercent = parseFloat(equityInput.value) / 100 || 0;
                    const loanRate = parseFloat(loanRateInput.value) / 100 || 0;
                    const loanTerm = parseFloat(loanTermInput.value) || 0;
                    
                    totalCapex = projectCost * equityPercent;
                    const loanAmount = projectCost * (1 - equityPercent);

                    if (loanRate > 0 && loanTerm > 0) {
                        const monthlyRate = loanRate / 12;
                        const numberOfPayments = loanTerm * 12;
                        annualLoanPayment = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1) * 12;
                    }
                    
                } else if (isSharingScenario) {
                    totalCapex = buildingCost;
                    investorSharePercent = parseFloat(investorShareInput.value) / 100 || 0;
                    landOwnerSharePercent = parseFloat(landOwnerShareInput.value) / 100 || 0;
                } else { // Lease Scenario
                    totalCapex = buildingCost;
                    landLeaseCost = unformatRupiah(landLeaseCostInput.value) || 0;
                }

                const accommodationRevenueY1 = (jumlahTipe1 * adrTipe1 * annualDays * occupancy) + (jumlahTipe2 * adrTipe2 * annualDays * occupancy);
                const totalRevenueY1 = accommodationRevenueY1 + (accommodationRevenueY1 * fnbRevenuePercent);
                const maintenanceCostY1 = buildingCost * maintenanceRate;
                const totalOpexY1 = (totalRevenueY1 * opexRate) + fixedOpex + maintenanceCostY1 + landLeaseCost + annualLoanPayment;
                const ebitY1 = totalRevenueY1 - totalOpexY1;
                const netProfitProjectY1 = ebitY1 * (1 - taxRate);

                let netProfitInvestorY1 = netProfitProjectY1 * investorSharePercent;
                const roi = (totalCapex > 0) ? (netProfitInvestorY1 / totalCapex) * 100 : 0;
                
                let landOwnerProfitY1 = 0;
                if (isSharingScenario) {
                     landOwnerProfitY1 = netProfitProjectY1 * landOwnerSharePercent;
                }
                
                let npv = 0;
                let cumulativeCashFlow = 0;
                let paybackYears = 'Tidak Akan Kembali Modal';
                let isPaybackFound = false;
                let prevCumulativeCashFlow = 0;

                let projectedRevenue = totalRevenueY1;
                let projectedFixedOpex = fixedOpex;
                let projectedMaintenanceCost = maintenanceCostY1;
                let projectedLandLeaseCost = landLeaseCost;

                for (let i = 1; i <= projectionPeriod; i++) {
                    const projectedVariableOpex = projectedRevenue * opexRate;
                    const projectedTotalOpex = projectedVariableOpex + projectedFixedOpex + projectedMaintenanceCost + projectedLandLeaseCost + annualLoanPayment;
                    const ebit = projectedRevenue - projectedTotalOpex;
                    const netProfit = ebit * (1 - taxRate);
                    const cashFlow = netProfit * investorSharePercent;

                    npv += cashFlow / Math.pow(1 + discountRate, i);
                    
                    if (!isPaybackFound) {
                        cumulativeCashFlow += cashFlow;
                        if (cumulativeCashFlow >= totalCapex) {
                             paybackYears = i + (totalCapex - prevCumulativeCashFlow) / (cumulativeCashFlow - prevCumulativeCashFlow);
                             paybackYears = `${numberFormatter.format(paybackYears)} tahun`;
                             isPaybackFound = true;
                        }
                    }
                    prevCumulativeCashFlow = cumulativeCashFlow;

                    projectedRevenue *= (1 + revenueGrowth);
                    projectedFixedOpex *= (1 + opexGrowth);
                    projectedMaintenanceCost *= (1 + opexGrowth);
                    projectedLandLeaseCost *= (1 + opexGrowth);
                }

                latestCalculatedMetrics = {
                    totalCapex: totalCapex,
                    totalRevenueY1: totalRevenueY1,
                    netProfitInvestorY1: netProfitInvestorY1,
                    roi: roi,
                    paybackYears: paybackYears,
                    npv: npv,
                    landOwnerProfitY1: landOwnerProfitY1,
                    scenario: currentScenario,
                    
                    // Store input values for the report
                    inputs: {
                        landPrice: landPriceInput.value,
                        landLeaseCost: landLeaseCostInput.value,
                        buildingCost: buildingCostInput.value,
                        equity: equityInput.value,
                        loanRate: loanRateInput.value,
                        loanTerm: loanTermInput.value,
                        investorShare: investorShareInput.value,
                        landOwnerShare: landOwnerShareInput.value,
                        adrTipe1: adrTipe1Input.value,
                        adrTipe2: adrTipe2Input.value,
                        occupancy: occupancyInput.value,
                        fnbRevenue: fnbRevenueInput.value,
                        opexRate: opexRateInput.value,
                        fixedOpex: fixedOpexInput.value,
                        maintenanceRate: maintenanceRateInput.value,
                        revenueGrowth: revenueGrowthInput.value,
                        opexGrowth: opexGrowthInput.value,
                        taxRate: taxRateInput.value,
                        discountRate: discountRateInput.value,
                    }
                };


                totalCapexEl.textContent = formatter.format(totalCapex);
                totalRevenueEl.textContent = formatter.format(totalRevenueY1);
                netProfitEl.textContent = formatter.format(netProfitInvestorY1);
                roiEl.textContent = `${numberFormatter.format(roi)}%`;
                npvEl.textContent = formatter.format(npv);
                paybackEl.textContent = paybackYears;
                landOwnerProfitEl.textContent = formatter.format(landOwnerProfitY1);

                if (isNaN(npv) || !isFinite(npv)) {
                    npvEl.textContent = 'Rp 0';
                }

                if (isNaN(roi) || !isFinite(roi)) {
                    roiEl.textContent = '0%';
                }

                const circumference = 2 * Math.PI * 50;
                let roiValue = Math.min(Math.max(roi, 0), 200);
                const offset = circumference - (roiValue / 200 * circumference);
                
                roiArc.style.strokeDasharray = circumference;
                roiArc.style.strokeDashoffset = offset;
                roiText.textContent = `${Math.round(roiValue)}%`;

                if (roi > 0) {
                    roiArc.classList.remove('text-red-500');
                    roiArc.classList.add('text-green-500');
                } else {
                    roiArc.classList.remove('text-green-500');
                    roiArc.classList.add('text-red-500');
                }

                 // Hide summary and enable the summary and export button
                summaryContainer.classList.add('hidden');
                generateSummaryBtn.disabled = false;
                generateSummaryBtn.classList.remove('bg-indigo-400', 'cursor-not-allowed');
                generateSummaryBtn.classList.add('hover:bg-indigo-700');
                exportBtn.disabled = false;
                exportBtn.classList.remove('bg-slate-400', 'cursor-not-allowed');
                exportBtn.classList.add('hover:bg-slate-700');
            };

            const handleCalculateClick = () => {
                buttonText.textContent = 'Menghitung...';
                buttonSpinner.classList.remove('hidden');
                calculateBtn.disabled = true;
                calculateBtn.classList.add('bg-blue-400', 'cursor-not-allowed');
                calculateBtn.classList.remove('hover:bg-blue-700');

                setTimeout(() => {
                    calculateMetrics();
                    buttonText.textContent = 'Lakukan Proyeksi';
                    buttonSpinner.classList.add('hidden');
                    calculateBtn.disabled = false;
                    calculateBtn.classList.remove('bg-blue-400', 'cursor-not-allowed');
                    calculateBtn.classList.add('hover:bg-blue-700');
                }, 1500);
            };

            const handleGenerateSummary = async () => {
                summaryContainer.classList.add('hidden');
                generateSummaryBtn.disabled = true;
                generateSummaryBtn.innerHTML = 'Membuat Ringkasan...';

                const { totalCapex, totalRevenueY1, netProfitInvestorY1, roi, paybackYears, npv, scenario } = latestCalculatedMetrics;
                const scenarioName = {
                    'buy': 'Akuisisi Lahan (Tunai)',
                    'loan': 'Akuisisi Lahan (Utang)',
                    'lease': 'Sewa Lahan',
                    'sharing': 'Joint Venture'
                }[scenario];
                
                const prompt = `Bertindak sebagai analis keuangan tingkat senior. Buat ringkasan eksekutif yang rapi dan terstruktur dalam format Markdown. Gunakan judul dan sub-judul untuk setiap bagian, serta poin-poin untuk metrik kunci. Gunakan bahasa Indonesia yang formal. Hindari simbol-simbol tidak berguna. Ini adalah proposal investasi "Menjer Ridge Cabins" dengan skenario "${scenarioName}". Masukkan metrik keuangan ini:
                - Total Biaya Modal (CapEx): ${formatter.format(totalCapex)}
                - Total Pendapatan Tahun Pertama: ${formatter.format(totalRevenueY1)}
                - Laba Bersih Tahun Pertama: ${formatter.format(netProfitInvestorY1)}
                - ROI (Tahun 1): ${numberFormatter.format(roi)}%
                - Periode Pengembalian Modal: ${paybackYears}
                - Net Present Value (NPV) (10 Tahun): ${formatter.format(npv)}
                Sajikan analisis yang profesional, menyoroti potensi proyek dan kelayakan investasi.`;

                 const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: "Anda adalah seorang analis keuangan senior yang menyusun ringkasan eksekutif dalam format Markdown yang rapi dan terstruktur." }]
                    },
                };

                try {
                    const response = await fetch(apiUrl + apiKey, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        latestSummaryText = text;
                        summaryText.innerHTML = marked.parse(text); // Menggunakan library marked.js untuk rendering Markdown
                        summaryContainer.classList.remove('hidden');
                    } else {
                        summaryText.textContent = "Maaf, gagal membuat ringkasan. Silakan coba lagi.";
                        summaryContainer.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    summaryText.textContent = "Terjadi kesalahan saat menghubungi API. Silakan coba lagi nanti.";
                    summaryContainer.classList.remove('hidden');
                } finally {
                    generateSummaryBtn.innerHTML = 'Buat Ringkasan Eksekutif';
                    generateSummaryBtn.disabled = false;
                }
            };
            
            const handleExportClick = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const scenarioName = {
                    'buy': 'Akuisisi Lahan (Tunai)',
                    'loan': 'Akuisisi Lahan (Utang)',
                    'lease': 'Sewa Lahan',
                    'sharing': 'Joint Venture'
                }[latestCalculatedMetrics.scenario];

                // Create a temporary element to render the report content for PDF
                const reportContent = document.createElement('div');
                reportContent.style.width = '210mm'; // A4 width
                reportContent.style.padding = '20mm';
                reportContent.style.fontSize = '12pt';

                reportContent.innerHTML = `
                    <h1 style="font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 20px;">Laporan Proyeksi Keuangan: Menjer Ridge Cabins</h1>
                    <ul style="margin-bottom: 20px; list-style-type: none; padding-left: 0;">
                        <li><strong>Proyek:</strong> Menjer Ridge Cabins</li>
                        <li><strong>Lokasi:</strong> Jalan Bukit Cinta, Desa Maron, Garung, Wonosobo, Jawa Tengah, 56354</li>
                        <li><strong>Luas Lahan:</strong> 3.072,9 mÂ²</li>
                        <li><strong>Skenario Investasi:</strong> ${scenarioName}</li>
                    </ul>

                    <h2 style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Ringkasan Metrik Kinerja Kunci</h2>
                    <ul style="margin-bottom: 20px;">
                        <li><strong>Total Biaya Modal (CapEx):</strong> ${formatter.format(latestCalculatedMetrics.totalCapex)}</li>
                        <li><strong>Total Pendapatan Proyek (Tahun 1):</strong> ${formatter.format(latestCalculatedMetrics.totalRevenueY1)}</li>
                        <li><strong>Laba Bersih Setelah Pajak (Tahun 1):</strong> ${formatter.format(latestCalculatedMetrics.netProfitInvestorY1)}</li>
                        <li><strong>ROI (Return on Investment) (Tahun 1):</strong> ${numberFormatter.format(latestCalculatedMetrics.roi)}%</li>
                        <li><strong>Periode Pengembalian (Payback Period):</strong> ${latestCalculatedMetrics.paybackYears}</li>
                        <li><strong>NPV (Net Present Value) (10 Tahun):</strong> ${formatter.format(latestCalculatedMetrics.npv)}</li>
                        ${latestCalculatedMetrics.scenario === 'sharing' ? `<li><strong>Laba Bersih untuk Pemilik Lahan (Tahun 1):</strong> ${formatter.format(latestCalculatedMetrics.landOwnerProfitY1)}</li>` : ''}
                    </ul>

                    <h2 style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Asumsi Parameter</h2>
                    <ul style="margin-bottom: 20px;">
                        <li><strong>Biaya Lahan:</strong> ${latestCalculatedMetrics.inputs.landPrice}</li>
                        <li><strong>Biaya Sewa Lahan:</strong> ${latestCalculatedMetrics.inputs.landLeaseCost}</li>
                        <li><strong>Biaya Konstruksi & Fasilitas:</strong> ${latestCalculatedMetrics.inputs.buildingCost}</li>
                        <li><strong>Rasio Ekuitas:</strong> ${latestCalculatedMetrics.inputs.equity}%</li>
                        <li><strong>Bunga Pinjaman Tahunan:</strong> ${latestCalculatedMetrics.inputs.loanRate}%</li>
                        <li><strong>Jangka Waktu Pinjaman:</strong> ${latestCalculatedMetrics.inputs.loanTerm} Tahun</li>
                        <li><strong>Porsi Bagi Hasil Investor:</strong> ${latestCalculatedMetrics.inputs.investorShare}%</li>
                        <li><strong>Porsi Bagi Hasil Pemilik Lahan:</strong> ${latestCalculatedMetrics.inputs.landOwnerShare}%</li>
                        <li><strong>ADR Tipe 1:</strong> ${latestCalculatedMetrics.inputs.adrTipe1}</li>
                        <li><strong>ADR Tipe 2:</strong> ${latestCalculatedMetrics.inputs.adrTipe2}</li>
                        <li><strong>Okupansi Tahunan:</strong> ${latestCalculatedMetrics.inputs.occupancy}%</li>
                        <li><strong>Pendapatan F&B:</strong> ${latestCalculatedMetrics.inputs.fnbRevenue}%</li>
                        <li><strong>Rasio OPEX Variabel:</strong> ${latestCalculatedMetrics.inputs.opexRate}%</li>
                        <li><strong>OPEX Tetap:</strong> ${latestCalculatedMetrics.inputs.fixedOpex}</li>
                        <li><strong>Biaya Pemeliharaan Tahunan:</strong> ${latestCalculatedMetrics.inputs.maintenanceRate}%</li>
                        <li><strong>Pertumbuhan Pendapatan Tahunan:</strong> ${latestCalculatedMetrics.inputs.revenueGrowth}%</li>
                        <li><strong>Pertumbuhan OPEX Tahunan:</strong> ${latestCalculatedMetrics.inputs.opexGrowth}%</li>
                        <li><strong>Tingkat Pajak Korporasi:</strong> ${latestCalculatedMetrics.inputs.taxRate}%</li>
                        <li><strong>Tingkat Diskonto:</strong> ${latestCalculatedMetrics.inputs.discountRate}%</li>
                    </ul>

                    <p style="font-size: 0.8em; color: gray; text-align: center; margin-top: 50px;">Laporan ini dibuat secara otomatis oleh Kalkulator Kelayakan Investasi Lanjutan</p>
                `;

                document.body.appendChild(reportContent);

                html2canvas(reportContent, {
                    scale: 2,
                    logging: true,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const imgWidth = 595.28; 
                    const pageHeight = 841.89;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    const doc = new jsPDF('p', 'pt', 'a4');
                    doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    doc.save(`Laporan-Proyeksi-Menjer-Ridge-Cabins.pdf`);
                    document.body.removeChild(reportContent);
                });
            };

            updateInputVisibility();
            buyOption.addEventListener('change', updateInputVisibility);
            loanOption.addEventListener('change', updateInputVisibility);
            leaseOption.addEventListener('change', updateInputVisibility);
            sharingOption.addEventListener('change', updateInputVisibility);
            calculateBtn.addEventListener('click', handleCalculateClick);
            generateSummaryBtn.addEventListener('click', handleGenerateSummary);
            exportBtn.addEventListener('click', handleExportClick);

            const allInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
            allInputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = allInputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                });
            });

        });
    </script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</body>
</html>
